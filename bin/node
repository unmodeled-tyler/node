#!/bin/bash

# Node CLI - Start all services and launch the application
# Usage: node [command]
#   node         - Start all services (backend + frontend)
#   node start   - Same as above
#   node stop    - Stop all services
#   node status  - Show status of services
#   node logs    - Show backend logs

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Get the directory where node is installed (resolve symlinks)
SCRIPT_PATH="${BASH_SOURCE[0]}"
while [ -L "$SCRIPT_PATH" ]; do
    SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
    SCRIPT_PATH="$(readlink "$SCRIPT_PATH")"
    [[ $SCRIPT_PATH != /* ]] && SCRIPT_PATH="$SCRIPT_DIR/$SCRIPT_PATH"
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT_PATH")" && pwd)"
NODE_ROOT="$(dirname "$SCRIPT_DIR")"

# Print banner
print_banner() {
    echo -e "${CYAN}"
    echo "  ╔═══════════════════════════════════════╗"
    echo "  ║           ${BOLD}NODE${NC}${CYAN}                          ║"
    echo "  ║   AI Workforce Desktop Application    ║"
    echo "  ╚═══════════════════════════════════════╝"
    echo -e "${NC}"
}

# Check if Docker is running
check_docker() {
    if ! docker info &> /dev/null; then
        echo -e "${RED}Error: Docker is not running. Please start Docker Desktop first.${NC}"
        exit 1
    fi
}

# Ensure .env.development exists with local mode config
ensure_env_config() {
    local env_file="$NODE_ROOT/.env.development"
    
    if [ ! -f "$env_file" ]; then
        echo -e "${YELLOW}Creating .env.development for local mode...${NC}"
        cat > "$env_file" << 'EOF'
VITE_BASE_URL=/api
VITE_USE_LOCAL_PROXY=true
VITE_PROXY_URL=http://localhost:3001
EOF
        echo -e "${GREEN}Created .env.development${NC}"
    fi
}

# Ensure server .env exists
ensure_server_env() {
    local env_file="$NODE_ROOT/server/.env"
    local env_example="$NODE_ROOT/server/.env.example"
    
    if [ ! -f "$env_file" ] && [ -f "$env_example" ]; then
        echo -e "${YELLOW}Creating server/.env from example...${NC}"
        cp "$env_example" "$env_file"
        echo -e "${GREEN}Created server/.env${NC}"
    fi
}

# Start backend services
start_backend() {
    echo -e "${YELLOW}Starting backend services...${NC}"
    
    cd "$NODE_ROOT/server"
    
    # Check if containers are already running
    if docker compose ps --status running 2>/dev/null | grep -q "node"; then
        echo -e "${GREEN}Backend services already running${NC}"
    else
        docker compose up -d
        echo -e "${GREEN}Backend services started${NC}"
    fi
    
    # Wait for API to be healthy
    echo -e "${YELLOW}Waiting for API to be ready...${NC}"
    local max_attempts=30
    local attempt=0
    
    while [ $attempt -lt $max_attempts ]; do
        if curl -s http://localhost:3001/health &> /dev/null; then
            echo -e "${GREEN}API is ready!${NC}"
            return 0
        fi
        attempt=$((attempt + 1))
        sleep 2
    done
    
    echo -e "${YELLOW}API taking longer than expected. Check 'node logs' if issues persist.${NC}"
}

# Start frontend
start_frontend() {
    echo -e "${YELLOW}Starting frontend...${NC}"
    
    cd "$NODE_ROOT"
    
    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo -e "${YELLOW}Installing dependencies (this may take a few minutes)...${NC}"
        npm install
    fi
    
    echo -e "${GREEN}========================================${NC}"
    echo -e "${GREEN}Node is starting!${NC}"
    echo -e "${CYAN}Frontend: http://localhost:7777${NC}"
    echo -e "${CYAN}API Docs: http://localhost:3001/docs${NC}"
    echo -e "${GREEN}========================================${NC}"
    echo -e "${YELLOW}Press Ctrl+C to stop${NC}"
    echo ""
    
    npm run dev
}

# Stop all services
stop_services() {
    echo -e "${YELLOW}Stopping services...${NC}"
    
    # Stop Docker containers
    cd "$NODE_ROOT/server"
    docker compose stop
    
    echo -e "${GREEN}All services stopped${NC}"
}

# Show status
show_status() {
    echo -e "${BOLD}Backend Services:${NC}"
    cd "$NODE_ROOT/server"
    docker compose ps
    
    echo ""
    echo -e "${BOLD}API Health:${NC}"
    if curl -s http://localhost:3001/health &> /dev/null; then
        echo -e "${GREEN}API is healthy${NC}"
    else
        echo -e "${RED}API is not responding${NC}"
    fi
}

# Show logs
show_logs() {
    cd "$NODE_ROOT/server"
    docker compose logs -f
}

# Main
main() {
    local command="${1:-start}"
    
    case "$command" in
        start|"")
            print_banner
            check_docker
            ensure_server_env
            ensure_env_config
            start_backend
            start_frontend
            ;;
        stop)
            stop_services
            ;;
        status)
            show_status
            ;;
        logs)
            show_logs
            ;;
        help|--help|-h)
            echo "Usage: node [command]"
            echo ""
            echo "Commands:"
            echo "  start   Start all services (default)"
            echo "  stop    Stop all services"
            echo "  status  Show status of services"
            echo "  logs    Show backend logs"
            echo "  help    Show this help message"
            ;;
        *)
            echo -e "${RED}Unknown command: $command${NC}"
            echo "Run 'node help' for usage"
            exit 1
            ;;
    esac
}

main "$@"
